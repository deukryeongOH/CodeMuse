<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CodeMuse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bgAnimation {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
        .animated-bg {
          background: linear-gradient(-45deg, #1a202c, #2d3748, #4a5568, #718096);
          background-size: 400% 400%;
          animation: bgAnimation 20s ease infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

<!-- 오른쪽 상단 홈 버튼 -->
<a th:href="@{/dashboard}"
   class="absolute top-4 right-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">
    홈
</a>

<div class="flex min-h-screen">

    <!-- 사이드바 -->
    <aside class="w-1/4 p-4 bg-gray-800 overflow-auto">
        <h3 class="text-xl font-semibold mb-4 text-white">프로젝트 코드 목록</h3>
        <ul class="space-y-3">
            <li th:each="code : ${codes}" class="flex justify-between items-center">
                <a href="javascript:void(0)"
                   class="text-blue-400 hover:underline flex-1"
                   th:attr="
             data-provided-code=${code.providedCode},
             data-improved-code=${code.review != null} ? ${code.review.improvedCode} : '',
             data-explanation=${code.review != null} ? ${code.review.explanation} : '',
             data-learning-links=${linksJson}"
                th:text="${code.id}"
                   onclick="showCode(this); return false;">
                </a>
                <form th:action="@{/project/{projectId}/delete/code/{codeId}(projectId=${projectId},codeId=${code.id})}"
                      th:method="post"
                      class="inline">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit"
                            class="ml-2 px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-white text-sm">
                        삭제
                    </button>
                </form>
            </li>
        </ul>
    </aside>

    <!-- 중앙 내용 -->
    <main class="w-3/4 p-8 bg-gray-900 text-white overflow-auto">
        <h2 class="text-3xl font-semibold mb-4" th:text="${title}">프로젝트 제목</h2>
        <p class="text-lg mb-8" th:text="${description}">프로젝트 설명</p>

        <div id="code-content" class="bg-gray-700 p-4 rounded-lg shadow-lg text-gray-200">
            <!-- 클릭 전 안내 -->
            <p id="placeholder" class="italic">목록에서 코드를 클릭하면 여기에 표시됩니다.</p>

            <!-- 클릭 후 상세 뷰 -->
            <div id="detail-view" class="hidden space-y-6">
                <div>
                    <h4 class="font-semibold mb-1">🔹 제공된 코드</h4>
                    <pre id="provided-code" class="bg-gray-800 p-3 rounded whitespace-pre-wrap"></pre>
                </div>
                <div>
                    <h4 class="font-semibold mb-1">🔹 개선된 코드</h4>
                    <pre id="improved-code" class="bg-gray-800 p-3 rounded whitespace-pre-wrap"></pre>
                </div>
                <div>
                    <h4 class="font-semibold mb-1">🔹 설명</h4>
                    <p id="explanation" class="bg-gray-800 p-3 rounded whitespace-pre-wrap"></p>
                </div>
                <div id="learning-links-section" class="hidden">
                    <h4 class="font-semibold mb-1">🔹 관련 학습 링크</h4>
                    <p id="learning-links" class="bg-gray-800 p-3 rounded whitespace-pre-wrap"></p>
                </div>
            </div>
        </div>
    </main>
</div>

<script th:inline="javascript">
    // Base64 디코딩 함수 (UTF-8 문자 깨짐 방지)
    function decodeBase64(str) {
        try {
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        } catch (e) {
            console.error('Base64 decode failed', e);
            return '[]'; // 오류 발생 시 빈 배열 형태의 문자열 반환
        }
    }

    function showCode(el) {
        document.getElementById('placeholder').classList.add('hidden');
        document.getElementById('detail-view').classList.remove('hidden');

        var provided = el.getAttribute('data-provided-code') || '';
        var improved = el.getAttribute('data-improved-code') || '';
        var explanation = el.getAttribute('data-explanation') || '';
        var learningLinksEncoded = el.getAttribute('data-learning-links') || ''; // 링크 데이터는 이미 JSON 문자열 형태

        document.getElementById('provided-code').textContent = provided;
        document.getElementById('improved-code').textContent = improved;
        document.getElementById('explanation').textContent = explanation;

        var linksSection = document.getElementById('learning-links-section');
        var linksList = document.getElementById('learning-links');

        linksList.innerHTML = '';

        if (learningLinksEncoded) {
            try {
                var links = JSON.parse(learningLinksEncoded); // 이미 JSON 문자열이므로 바로 파싱
                if (Array.isArray(links) && links.length > 0) {
                    links.forEach(function(link) {
                        var li = document.createElement('li');
                        var a = document.createElement('a');
                        a.href = link.url;
                        a.textContent = link.title || link.url;
                        a.target = "_blank";
                        a.className = "hover:underline";
                        li.appendChild(a);
                        linksList.appendChild(li);
                    });
                    linksSection.classList.remove('hidden');
                } else {
                    linksSection.classList.add('hidden');
                }
            } catch (e) {
                console.error('Failed to parse learning links JSON', e);
                linksSection.classList.add('hidden');
            }
        } else {
            linksSection.classList.add('hidden');
        }
    }
</script>
</body>
</html>